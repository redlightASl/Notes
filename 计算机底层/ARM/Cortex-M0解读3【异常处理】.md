# Cortex-M0解读3【异常处理】

在前面内容里都有意忽略了异常处理部分，本篇将这个重要的模块单独分析。





## NVIC

Cortex-M处理器的中断交由NVIC嵌套向量中断控制器管理，NVIC的控制寄存器位于系统控制空间SCS内。这个内核外设提供了如下方便的特性

* **灵活的中断管理**

    每个外部中断都是可使能/禁止的，并且每个中断都有一个单独的中断请求标志位，可以由软件设置或清除**中断请求标志**。

    NVIC可以识别**异常信号电平**或**异常请求脉冲**，前者由一个锁存器保存到NVIC，在中断请求标志位被清除前会一直保持；后者则是一个长短不一但最小不短于1个时钟周期的脉冲信号。

    NVIC能够适应任何片上外设，只要他们发出的信号满足上面两个情况之一

* **嵌套中断**

    如果处理器正在处理一个中断，而新的中断产生后，NVIC会比较它与当前执行中断的优先级，如果新中断优先级较高，那么当前执行的任务会被暂停，保存当前上下文后处理新的高优先级异常，这被称为“**抢占**”

    更高优先级异常完成后，会恢复原有异常处理环境的上下文，并继续执行低优先级的ISR

    如果两个相同优先级的异常发生，那么NVIC会直接为它们安排“**衔尾中断**”：先发生的异常先执行，当这个异常完成后，无需恢复原有前台程序的上下文，而是直接载入另一个异常的上下文，处理完另一个异常后再恢复到前台程序的运行环境，这样就*节约了一次恢复-保存现场的开销*

* **向量异常入口**

    *NVIC会从存储器的向量表里面自动确定异常处理程序的入口*，从而降低异常产生到异常执行器件的延迟

    > 这个特性是ARM7TMDI等应用处理器所不具备的，目的是为了提高处理器的实时性

* **中断屏蔽**

    NVIC可以根据PRIMASK寄存器来屏蔽全局外部中断，也可以使用控制寄存器内的屏蔽位对单个中断进行控制。ARMv7-M处理器还具有其他控制位，不过这就不是CM0能实现的了

### 中断向量表

![image-20221009141913756](Cortex-M0解读3【异常处理】.assets/image-20221009141913756.png)

众所周知，Cortex-M系列的中断向量表（Interrupt Vector Table）保存了每个异常对应的中断服务函数（ISR）的地址。官方的默认安排如上图所示

需要注意几个关键点：

* 向量表第一个值应当为初始MSP
* 从第二个值到第16个值是指令集架构规定的中断服务函数地址，顺序一定要正确
* 向量表中最多包含496个外部中断
* 中断向量表的大小为2048字节
* 用户可以通过SCS中的向量表偏置寄存器来重新分配向量表的位置，但0x0处必须有最小的向量表入口——只有向量表被加载完毕，处理器内核才算正常启动
* ARM提供了BootLoader模板，用户可以在其基础上用汇编或者C定义自己的BootLoader

### 异常类型









### 异常处理流水线







### NVIC寄存器









