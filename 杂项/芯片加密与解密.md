# 芯片逆向原理摘录

## 片上二进制代码逆向

芯片代码逆向的基础就是**芯片失效分析**流程。

首先需要分析芯片型号，在这个过程中可能会遇到丝印被打磨掉的芯片或是无丝印的定制芯片，这个就需要根据板卡和引脚封装进行判断了。有了芯片型号才能够知道CPU的指令集和微架构，从而了解片上Flash中存储的二进制代码如何进行反汇编。

随后需要使用激光打标机去除外层的塑料封装，一般使用1064nm的高功率激光（部分大功率的激光雕刻机也采用该波段）对芯片封装进行重复雕刻。在这个过程中，部分芯片会使用环氧树脂灌封，也就是所谓的黑胶，也有用三防漆涂敷的情况发生，一般使用通用环氧树脂溶解剂或专用的黑胶溶解剂进行处理。环氧树脂溶解剂可以将大部分PLA、ABS材料溶解掉，但对于硫化橡胶或采用特殊配比的高性能环氧树脂（一般呈黑色），就需要用专用黑胶溶解剂处理。这种黑胶溶解剂只能能够将这样的黑胶外层软化，一般需要多次浸泡、切割表层，重复直到出现芯片固有的塑封。芯片塑封强度是最高的，一般采用掺杂二氧化硅填料的环氧树脂进行灌封，因此很难被一般有机溶剂溶解。如果采用化学方法处理芯片塑封，一般考虑采用强酸腐蚀，如发烟硝酸等强酸可以将芯片塑封腐蚀掉而不损坏内部晶圆。一般来说，对芯片进行开盖最便捷高效的方式还是激光。在激光打标机的常见功率下，激光束不会对晶圆造成影响。

完成上述步骤后，可以得到带有外部保护层的裸晶圆（也可能只将die的顶层封装去除掉），这时候就需要进行传统芯片失效分析流程了。

一颗裸die顶部包含了：

- 有机材料保护层或二氧化硅保护层：保证芯片内部电路处于稳定状态
- 钝化层：一般采用Si3N4沉积工艺制造，防止外界水汽渗透
- 金属层：一般采用铝金属沉积工艺制造，用于晶圆上CMOS和元器件的连线

在分析过程中，需要使用化学机械平坦化（弱酸腐蚀高精度打磨）或机械平坦化（使用微粒磨料高精度打磨）的方法将这些层去掉，直至露出芯片本体。

> 高功率激光对于这些保护层的效果不佳

一个具有片上Flash存储器的SoC一般具有明显的分区结构，通过红外线、X射线和可见光衍射光都可以得到芯片的dieshot，从而获得片上Flash的具体位置。

对于一般的芯片失效分析，更关注的是哪里有意外的短路开路，因此在这一步就结束了。但对于芯片逆向，还需要使用离子染料对存储器区域进行**染色**。常见的Flash采用字线结构，以晶体管阵列形式排布，每个晶体管都具有一个用于存储电荷的浮栅结构。对于数据存储单元，如果其中存储了高电平1，则表现为浮栅带正电荷，离子染料将被正电荷吸附，而不带电的存储单元不会吸附染料。在对表面进行清洗后，染料会使得晶体管呈现出不同颜色。

完成染色后，对芯片进行显微拍照，拼接后使用软件工具以机器视觉方案分析代表0和1的晶体管，就可以获得原始的二进制代码了。值得注意的是：在全部过程中，芯片不需要通电，因此传统的通电自毁方案对这样的逆向流程是无效的。

## 芯片加密与解密案例

对于很多安全等级高的国密芯片，会采用“见光死”方案，即在芯片封装内设置冗余的加密晶圆，晶圆制造为光敏二极管的形式，当激光或高强度光线照射晶圆后，就会产生一定光敏电流，将Flash存储区预设的熔丝熔断，导致全部二进制值错乱，无法继续逆向。这样的芯片不能使用激光雕刻方式处理，只能使用化学机械平坦化设备在暗室中进行打磨，并将冗余晶圆拆除。

另有一套常见的软硬件加密手段：芯片唯一ID加密。MCU厂商会为每个芯片提供一个ID，这个ID以金属层硬连线的方式实现。在程序正常烧录时，烧录软件读取芯片的唯一ID号，通过指定的哈希算法处理后再写入片上的Flash，而MCU执行程序时，会按照同样的算法对Flash上加密过的代码进行解密，再加载到片上SRAM以供CPU使用，这个过程一般以硬件完成（也可以通过软件方式复现，但需要划分Flash为加密区域和未加密区域，CPU先从未加密区域启动并执行解密算法）。这类代码的逆向关键在于找出其中的芯片唯一ID和哈希算法。唯一ID可以通过各种侧信道攻击方式得到，也可以通过直接爆破的方式得到，因为大部分芯片厂商提供的唯一ID都不会特别长（8位或16位）。而哈希算法往往可以从芯片的厂商文档中找到，或者也可以通过芯片上电后的侧信道攻击得到。